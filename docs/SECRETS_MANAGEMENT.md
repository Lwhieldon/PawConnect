# PawConnect AI - Secrets Management Guide

This guide covers how to securely manage credentials and sensitive data for PawConnect AI using Google Cloud Secret Manager.

## Table of Contents

1. [Overview](#overview)
2. [Quick Start](#quick-start)
3. [Required Secrets](#required-secrets)
4. [Setup Methods](#setup-methods)
5. [Local Development](#local-development)
6. [Production Deployment](#production-deployment)
7. [Secret Rotation](#secret-rotation)
8. [Troubleshooting](#troubleshooting)
9. [Best Practices](#best-practices)

---

## Overview

**Why Secret Manager?**

Google Cloud Secret Manager provides:
- ✅ **Encryption** - Secrets encrypted at rest and in transit
- ✅ **Access Control** - IAM-based permissions
- ✅ **Versioning** - Keep multiple versions of secrets
- ✅ **Audit Logging** - Track all access to secrets
- ✅ **Integration** - Works seamlessly with Cloud Run, GKE, etc.

**Cost:** ~$0.06 per 10,000 secret versions per month (first 6 versions per secret are FREE)

---

## Quick Start

### 1. Enable Secret Manager

```bash
gcloud services enable secretmanager.googleapis.com
```

### 2. Create Secrets (Interactive)

```bash
# Use our helper script
./deployment/scripts/setup-secrets.sh
```

This will prompt you for:
- RescueGroups API Key
- Dialogflow Agent ID
- Redis Password (optional, auto-generated by Memorystore)

### 3. Validate Configuration

```bash
./deployment/scripts/validate-secrets.sh
```

### 4. Deploy to Production

Secrets are automatically injected into Cloud Run services via `--set-secrets` flag:

```bash
gcloud builds submit --config deployment/cloudbuild.yaml
```

---

## Required Secrets

PawConnect requires three secrets:

### 1. `rescuegroups-api-key`

**Purpose:** API authentication for RescueGroups.org

**How to obtain:**
1. Sign up at [RescueGroups.org](https://rescuegroups.org/)
2. Request API access: [API Developers Guide](https://userguide.rescuegroups.org/display/APIDG/API+Developers+Guide+Home)
3. Save your API key

**Create:**
```bash
echo -n "YOUR_API_KEY" | gcloud secrets create rescuegroups-api-key --data-file=-
```

### 2. `redis-password`

**Purpose:** Authentication for Memorystore (Redis) cache

**How to obtain:**
- Auto-generated when you create a Memorystore instance
- Retrieved with: `gcloud redis instances get-auth-string INSTANCE_NAME --region=REGION`

**Create:**
```bash
# Initially create with placeholder
echo -n "temporary" | gcloud secrets create redis-password --data-file=-

# Update after creating Memorystore
gcloud redis instances get-auth-string pawconnect-redis --region=us-central1 | \
  gcloud secrets versions add redis-password --data-file=-
```

### 3. `dialogflow-agent-id`

**Purpose:** Connect to your Dialogflow CX agent

**How to obtain:**
1. Create Dialogflow CX agent at [Dialogflow Console](https://dialogflow.cloud.google.com/cx)
2. Get agent ID from agent settings (format: `projects/PROJECT/locations/LOCATION/agents/AGENT_ID`)

**Create:**
```bash
echo -n "YOUR_AGENT_ID" | gcloud secrets create dialogflow-agent-id --data-file=-
```

---

## Setup Methods

### Method 1: Interactive Setup (Recommended)

Use our helper script for guided setup:

```bash
./deployment/scripts/setup-secrets.sh
```

**Features:**
- ✅ Prompts for each secret
- ✅ Hides input (secure)
- ✅ Updates existing secrets
- ✅ Configures IAM automatically
- ✅ Validates setup

### Method 2: Manual gcloud Commands

```bash
# Create secrets
echo -n "YOUR_VALUE" | gcloud secrets create SECRET_NAME --data-file=-

# Grant access to service account
PROJECT_NUMBER=$(gcloud projects describe PROJECT_ID --format="value(projectNumber)")
SERVICE_ACCOUNT="${PROJECT_NUMBER}-compute@developer.gserviceaccount.com"

gcloud secrets add-iam-policy-binding SECRET_NAME \
  --member="serviceAccount:${SERVICE_ACCOUNT}" \
  --role="roles/secretmanager.secretAccessor"
```

### Method 3: Terraform

See `deployment/terraform/main.tf` for secret resources:

```hcl
resource "google_secret_manager_secret" "rescuegroups_api_key" {
  secret_id = "rescuegroups-api-key"
  replication {
    auto {}
  }
}
```

---

## Local Development

### Option 1: Load Secrets into Environment (Recommended)

**Linux/Mac:**
```bash
source deployment/scripts/load-secrets.sh
```

**Windows PowerShell:**
```powershell
. .\deployment\scripts\load-secrets.ps1
```

**What it does:**
- Fetches secrets from Secret Manager
- Sets environment variables: `RESCUEGROUPS_API_KEY`, `REDIS_PASSWORD`, `DIALOGFLOW_AGENT_ID`
- Variables persist in current shell session only

### Option 2: Manual Environment Variables

```bash
export RESCUEGROUPS_API_KEY=$(gcloud secrets versions access latest --secret="rescuegroups-api-key")
export REDIS_PASSWORD=$(gcloud secrets versions access latest --secret="redis-password")
export DIALOGFLOW_AGENT_ID=$(gcloud secrets versions access latest --secret="dialogflow-agent-id")
```

### Option 3: Python Secret Manager Client

Already integrated in PawConnect:

```python
from google.cloud import secretmanager

client = secretmanager.SecretManagerServiceClient()
secret_name = f"projects/{project_id}/secrets/rescuegroups-api-key/versions/latest"
response = client.access_secret_version(request={"name": secret_name})
api_key = response.payload.data.decode("UTF-8")
```

---

## Production Deployment

Secrets are automatically injected into Cloud Run services.

### Cloud Build (Automatic)

In `deployment/cloudbuild.yaml`:

```yaml
--set-secrets="\
RESCUEGROUPS_API_KEY=rescuegroups-api-key:latest,\
REDIS_PASSWORD=redis-password:latest,\
DIALOGFLOW_AGENT_ID=dialogflow-agent-id:latest"
```

### Manual Deployment

```bash
gcloud run deploy pawconnect-main-agent \
  --image gcr.io/PROJECT_ID/pawconnect-ai:latest \
  --set-secrets "\
RESCUEGROUPS_API_KEY=rescuegroups-api-key:latest,\
REDIS_PASSWORD=redis-password:latest,\
DIALOGFLOW_AGENT_ID=dialogflow-agent-id:latest"
```

### Verify Secrets in Cloud Run

```bash
# Check environment configuration
gcloud run services describe pawconnect-main-agent \
  --region us-central1 \
  --format="yaml(spec.template.spec.containers[0].env)"
```

---

## Secret Rotation

Regularly rotate secrets for security.

### Rotation Frequency

- **RescueGroups API Key:** Every 90 days
- **Redis Password:** When Memorystore instance is recreated
- **Dialogflow Agent ID:** Only when agent is recreated

### Rotation Process

**1. Update Secret Value:**
```bash
echo -n "NEW_VALUE" | gcloud secrets versions add SECRET_NAME --data-file=-
```

**2. Cloud Run automatically picks up latest version** (no redeployment needed)

**3. Force restart (optional):**
```bash
gcloud run services update pawconnect-main-agent --region=us-central1
```

### Automated Rotation Script

```bash
#!/bin/bash
# Example rotation script

SECRET_NAME="rescuegroups-api-key"

echo "Rotating $SECRET_NAME..."
read -sp "Enter new value: " NEW_VALUE
echo

# Add new version
echo -n "$NEW_VALUE" | gcloud secrets versions add $SECRET_NAME --data-file=-

# Test new secret
# Add validation logic here

# Restart services
gcloud run services update pawconnect-main-agent --region=us-central1
gcloud run services update pawconnect-dialogflow-webhook --region=us-central1

echo "✓ Rotation complete"
```

---

## Troubleshooting

### Secret Not Found

**Symptom:** `Secret [SECRET_NAME] not found`

**Solution:**
```bash
# Check if secret exists
gcloud secrets list | grep SECRET_NAME

# Create if missing
echo -n "VALUE" | gcloud secrets create SECRET_NAME --data-file=-
```

### Permission Denied

**Symptom:** `Permission denied on secret`

**Solution:**
```bash
# Verify IAM policy
gcloud secrets get-iam-policy SECRET_NAME

# Grant access
gcloud secrets add-iam-policy-binding SECRET_NAME \
  --member="serviceAccount:SERVICE_ACCOUNT" \
  --role="roles/secretmanager.secretAccessor"
```

### Cloud Run Can't Access Secrets

**Symptom:** Application errors about missing credentials

**Solution:**
```bash
# 1. Check service account
gcloud run services describe pawconnect-main-agent \
  --region=us-central1 \
  --format="value(spec.template.spec.serviceAccountName)"

# 2. Verify secrets configuration
gcloud run services describe pawconnect-main-agent \
  --region=us-central1 \
  --format="yaml(spec.template.spec.containers[0].env)"

# 3. Check IAM permissions
gcloud secrets get-iam-policy rescuegroups-api-key
```

### Validation Script Fails

**Symptom:** `validate-secrets.sh` shows errors

**Solution:**
```bash
# Run validation to see specific errors
./deployment/scripts/validate-secrets.sh

# Common fixes:
# 1. Wrong GCP project
gcloud config set project CORRECT_PROJECT_ID

# 2. Not authenticated
gcloud auth login

# 3. Missing permissions
# Contact project admin to grant Secret Manager Secret Accessor role
```

---

## Best Practices

### ✅ DO

1. **Always use Secret Manager** for production credentials
2. **Use `:latest` version** in Cloud Run for automatic updates
3. **Grant minimal permissions** - only Secret Accessor role
4. **Rotate secrets regularly** (e.g., every 90 days)
5. **Audit access logs** periodically
6. **Use helper scripts** for consistent setup
7. **Validate before deploying** with `validate-secrets.sh`
8. **Document secret sources** (where to get new values)

### ❌ DON'T

1. **Don't commit secrets to git** - ever!
2. **Don't put secrets in `.env`** file committed to repo
3. **Don't log secret values** in application code
4. **Don't share secrets via chat/email** - use Secret Manager
5. **Don't use the same secrets** for dev and prod
6. **Don't hardcode secrets** in source code
7. **Don't grant broad permissions** - use least privilege
8. **Don't skip secret rotation** - security requirement

---

## CI/CD Integration

### GitHub Actions Example

```yaml
name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Validate Secrets
        run: |
          ./deployment/scripts/validate-secrets.sh
          if [ $? -ne 0 ]; then
            echo "❌ Secret validation failed"
            exit 1
          fi

      - name: Deploy
        run: |
          gcloud builds submit --config deployment/cloudbuild.yaml
```

### Pre-deployment Checklist

```bash
# Run this before every production deployment
./deployment/scripts/validate-secrets.sh && \
  echo "✓ Secrets validated" || \
  { echo "❌ Secret validation failed"; exit 1; }
```

---

## Security Checklist

Before going to production:

- [ ] All secrets created in Secret Manager
- [ ] No secrets in `.env` file committed to git
- [ ] Service account has Secret Accessor role
- [ ] Secrets use `:latest` version in Cloud Run
- [ ] Local development uses `load-secrets.sh`
- [ ] Secret rotation schedule documented
- [ ] Team trained on secret management
- [ ] Audit logging enabled and monitored
- [ ] `.env` file is in `.gitignore`
- [ ] Validation script passes

---

## Additional Resources

- [Google Cloud Secret Manager Documentation](https://cloud.google.com/secret-manager/docs)
- [Secret Manager Best Practices](https://cloud.google.com/secret-manager/docs/best-practices)
- [PawConnect Deployment Guide](./DEPLOYMENT.md)
- [Helper Scripts Documentation](../deployment/scripts/README.md)

---

## Need Help?

- **Deployment issues:** See [DEPLOYMENT.md](./DEPLOYMENT.md)
- **Script usage:** See [deployment/scripts/README.md](../deployment/scripts/README.md)
- **GCP Support:** [Google Cloud Support](https://cloud.google.com/support)

---

**Remember:** Security is everyone's responsibility. Always protect credentials and follow best practices.
